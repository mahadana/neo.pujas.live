<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pujas.live Logs</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        text-align: center;
        background-color: rgb(87, 46, 12);
        color: rgb(236, 208, 185);
      }
      #container {
        display: flex;
        justify-content: space-evenly;
      }
      #deploy,
      #worker {
        margin: 0.5rem auto;
        width: calc(50vw - 1rem);
        height: calc(100vh - 8rem);
        border: 1px solid grey;
        background-color: black;
        color: white;
        overflow-x: hidden;
        overflow-y: scroll;
        text-align: left;
        font-size: 1.5vh;
        white-space: pre-wrap;
      }
      h1,
      h2,
      p {
        margin: 0;
      }
      h1 {
        margin-top: 0.5rem;
      }
      a {
        color: rgb(236, 174, 79);
      }
    </style>
  </head>
  <body>
    <h1><a href="/">Pujas.live</a> Logs</h1>
    <div id="container">
      <div>
        <h2>Deploy Log</h2>
        <pre id="deploy">Loading...</pre>
        <p><a href="deploy/">More deploy logs...</a></p>
      </div>
      <div>
        <h2>Worker Log</h2>
        <pre id="worker">Loading...</pre>
        <p><a href="worker/">More worker logs...</a></p>
      </div>
    </div>
  </body>
  <script>
    (async () => {
      const deployUrl = "deploy/latest-pujas.live-deploy.log";
      const workerUrl = "worker/latest-worker.log";

      let lastActive;
      const setActive = () => (lastActive = new Date());
      setActive();

      const deployEl = document.getElementById("deploy");
      const workerEl = document.getElementById("worker");

      deployEl.addEventListener("mousemove", setActive);
      workerEl.addEventListener("mousemove", setActive);

      const updateEl = async (el, url) => {
        const response = await fetch(url);
        el.textContent = await response.text();
        el.scrollTop = el.scrollHeight;
      };

      const update = async () => {
        updateEl(deployEl, deployUrl);
        updateEl(workerEl, workerUrl);
      };

      await update();

      setInterval(async () => {
        const interval = new Date().getTime() - lastActive.getTime();
        if (interval > 5000) {
          await update();
        }
      }, 2000);
    })().catch(console.error);
  </script>
</html>
